{% extends 'base.html' %}

{% block head %}
<title>Profile</title>
<form method="GET" action="{% url 'accounts:testemail' %}">
	<button type='submit'>TESTMAIL</button>
</form>
{% endblock %}

{% block title %}
<h3>Dashboard<h4>
{% endblock %}

{% block body %}
{% if tickets %}
<a id="ajaxUrl" href="{% url 'crm:ticket-filter' %}"></a>

  <div class="row">
    <div class="col s12">
      <ul class="tabs">
        <li id="currentissues" class="tab col s3"><a class="active" href="#test1">Current Issues</a></li>
        <li id="newticket" class="tab col s3"><a id="newtix" href="#test2">Start New Ticket</a></li>
        <li id="orders" class="tab col s3"><a href="#test3">View Orders and Invoices</a></li>
        <li id="contacts" class="tab col s3"><a href="#test4">Clients and Contacts</a></li>
      </ul>
    </div>
    <div id="test1" class="col s12">{% include 'crm_temps/tix.html' %}</div>
    <div id="test2" class="col s12">{% include 'crm_temps/tix.html' %}</div>
    <div id="test3" class="col s12">Test 3</div>
    <div id="test4" class="col s12">Test 4</div>
  </div>



<a id="ajax_url" href="{% url 'crm:ajax_req' %}"></a>
<a id="clients_url" href="{% url 'crm:client' %}"></a>
<a id="form_url" href="{% url 'crm:create_ticket' %}"></a>

{% else %}
<div class='container'>
<h2>username: {{ user }}</h2>
<h2>first name: {{ user.first_name }}</h2>
<h2>last name: {{ user.last_name }}</h2>
<h2>email: {{ user.email }}</h2>
</div>
<form method="POST" action="" id="auto_submit_form">
	{% csrf_token %}
	<input type="hidden" name="recent_tickets" value="{{ user.username }}"></input>
</form>
{% endif %}
<style>
.current-issues-window {
	max-height: 50vh;
	max-width: 30vw;
	overflow-x: hidden;
	overflow-y: scroll;
	background-color: lightgray;
	float: right;
}
</style>
<script type="text/javascript">
	$(document).ready(function(){
	$('#newtix').click(function(){
		$.get($('#form_url').attr('href'), function(data){
			$('#test2').html(data);
		});
	});
	$('#contacts').click(function(){
		$.get($('#clients_url').attr('href'), function(data){
			$('#test4').html(data);
		});
	})
	$("#auto_submit_form").submit();
	$('.tabs').tabs();

	$('#currentissues').click(function(){
		var urls = $("#ajaxUrl").attr('href');
		var filter = $(this).attr('id');
		$.ajax({
			type: "GET",
			dateType: "json",
			url: urls,
			data: {
				'ticketfilter' : filter
			},
			success:function(result){
				var dataRows = $('tbody tr');
				$.each(result, function(index, value){
					$('tbody').append($(
						"<tr><td data-label='Technician'>" +value.fields.technician+ "</td><td data-label='Ticket Title'>" +value.fields.ticket_title+ "</td><td data-label='Start Date'>"+value.fields.ticketstartdate+"</td><td data-label='Ticket Status'>"+value.fields.ticket_status+"</td><td><button value='"+value.pk+"' name='ticket' class='btn-floating btn-large waves-effect waves-light red'><i class='material-icons'>check</i></button></td></tr>"
						));				
										
							

					

				});
			},
			error: function() {
				alert('error');
			}
		});
	});
	});


///Try adding a function that executes the ajax call on the tix template. Then when the tab is clicked it will call the function??
//The easiest method may be to simply have types of ticket lists. 1- current tickets(everything in last 3 months) 2- 

		

	

</script>

{% endblock %}


